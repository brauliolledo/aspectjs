!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports,require("@aspectjs/core"),require("@aspectjs/core/commons"),require("@aspectjs/core/annotations"),require("@aspectjs/core/utils")):"function"==typeof define&&define.amd?define(["exports","@aspectjs/core","@aspectjs/core/commons","@aspectjs/core/annotations","@aspectjs/core/utils"],factory):factory(((global="undefined"!=typeof globalThis?globalThis:global||self).aspectjs=global.aspectjs||{},global.aspectjs.memo={}),global.aspectjs.core,global.aspectjs.core_commons,global.aspectjs.core_annotations,global.aspectjs.core_utils)}(this,(function(exports,core,commons,annotations,utils){"use strict";function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass)}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o})(o,p)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _construct(Parent,args,Class){return(_construct=_isNativeReflectConstruct()?Reflect.construct:function(Parent,args,Class){var a=[null];a.push.apply(a,args);var instance=new(Function.bind.apply(Parent,a));return Class&&_setPrototypeOf(instance,Class.prototype),instance}).apply(null,arguments)}function _wrapNativeSuper(Class){var _cache="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(Class){if(null===Class||(fn=Class,-1===Function.toString.call(fn).indexOf("[native code]")))return Class;var fn;if("function"!=typeof Class)throw new TypeError("Super expression must either be null or a function");if(void 0!==_cache){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper)}function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor)}return Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(Wrapper,Class)})(Class)}function _possibleConstructorReturn(self,call){if(call&&("object"==typeof call||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _get(target,property,receiver){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=function(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(receiver):desc.value}})(target,property,receiver||target)}function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||_unsupportedIterableToArray(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function __decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}function __metadata(metadataKey,metadataValue){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(metadataKey,metadataValue)}var _Cacheable=commons.ASPECTJS_ANNOTATION_FACTORY.create((function(typeId){}));exports.DefaultCacheableAspect=function(){function DefaultCacheableAspect(){var cacheTypeStore=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new _CacheTypeStoreImpl;_classCallCheck(this,DefaultCacheableAspect),this.cacheTypeStore=cacheTypeStore}return _createClass(DefaultCacheableAspect,[{key:"registerCacheKey",value:function(ctxt){var _a,options=ctxt.annotations.onSelf(_Cacheable)[0].args[0];utils.isObject(options)||(options={typeId:options});var proto,typeId=null!==(_a=options.typeId)&&void 0!==_a?_a:(proto=ctxt.target.proto,utils.getOrComputeMetadata("@aspectjs/cacheable:typekey",proto,(function(){return"".concat(proto.constructor.name,"#").concat(globalId++)})));this.cacheTypeStore.addPrototype(ctxt.target.proto,typeId,options.version)}}]),DefaultCacheableAspect}(),__decorate([annotations.Compile(commons.on.class.withAnnotations(_Cacheable)),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],exports.DefaultCacheableAspect.prototype,"registerCacheKey",null),exports.DefaultCacheableAspect=__decorate([annotations.Aspect("@aspectjs/cacheable"),__metadata("design:paramtypes",[Object])],exports.DefaultCacheableAspect);var _CacheTypeStoreImpl=function(){function _CacheTypeStoreImpl(){_classCallCheck(this,_CacheTypeStoreImpl),this._prototypes=new Map}return _createClass(_CacheTypeStoreImpl,[{key:"getPrototype",value:function(key){utils.assert(!!key,"key must be defined");var entry=this._prototypes.get(key);if(!entry)throw new Error("no prototype found for key ".concat(key));return entry.proto}},{key:"getTypeKey",value:function(prototype){return Reflect.getOwnMetadata("@aspectjs/cacheable:typekey",prototype)}},{key:"addPrototype",value:function(proto,typeId,version){var _a,_b,existingProto=this._prototypes.get(typeId);if(existingProto&&existingProto!==proto)throw new Error("Cannot call @Cacheable({typeId = ".concat(typeId,"}) on ").concat(null===(_a=null==proto?void 0:proto.constructor)||void 0===_a?void 0:_a.name,": typeId is already assigned to ").concat(null===(_b=null==existingProto?void 0:existingProto.constructor)||void 0===_b?void 0:_b.name));this._prototypes.set(typeId,{proto:proto,version:version})}},{key:"getVersion",value:function(key){var _a,_b;return null!==(_b=null===(_a=this._prototypes.get(key))||void 0===_a?void 0:_a.version)&&void 0!==_b?_b:void 0}}]),_CacheTypeStoreImpl}(),globalId=0;var TransactionMode,MemoDriver=function(){function MemoDriver(){_classCallCheck(this,MemoDriver)}return _createClass(MemoDriver,[{key:"getPriority",value:function(context){return 0}},{key:"accepts",value:function(context){return!0}}]),MemoDriver}(),MemoAspectError=function(_Error){_inherits(MemoAspectError,_Error);var _super=_createSuper(MemoAspectError);function MemoAspectError(message){var _this;return _classCallCheck(this,MemoAspectError),(_this=_super.call(this,message)).message=message,_this}return MemoAspectError}(_wrapNativeSuper(Error)),VersionConflictError=function(_MemoAspectError){_inherits(VersionConflictError,_MemoAspectError);var _super2=_createSuper(VersionConflictError);function VersionConflictError(message,context){var _this2;return _classCallCheck(this,VersionConflictError),(_this2=_super2.call(this,message)).message=message,_this2.context=context,_this2}return VersionConflictError}(MemoAspectError),MemoKey=function(){function MemoKey(key,namespace){_classCallCheck(this,MemoKey),this.namespace=null!=namespace?namespace:key.namespace,this.targetKey=key.targetKey,this.instanceId=key.instanceId,this.argsKey=key.argsKey,this._strValue="".concat("@aspectjs:Memo",":ns=").concat(this.namespace,"&tk=").concat(this.targetKey,"&id=").concat(this.instanceId,"&ak=").concat(this.argsKey)}return _createClass(MemoKey,[{key:"toString",value:function(){return this._strValue}}],[{key:"parse",value:function(str){var throwIfInvalid=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!str.startsWith("@aspectjs:Memo"))throw new TypeError("Key ".concat(str," is not a memo key"));var rx=new RegExp("".concat("@aspectjs:Memo",":ns=(?<namespace>.*?)&tk=(?<targetKey>.*?)&id=(?<instanceId>.*?)&ak=(?<argsKey>.*)")),r=rx.exec(str);if(!r){if(throwIfInvalid)throw new MemoAspectError("given expression is not a MemoKey: ".concat(str));return null}return new MemoKey(r.groups)}}]),MemoKey}(),MemoFrame=function(){function MemoFrame(frame){_classCallCheck(this,MemoFrame),Object.assign(this,frame)}return _createClass(MemoFrame,[{key:"setValue",value:function(value){this._resolved=!0,this.async=null;return this.value=value,this}},{key:"setAsyncValue",value:function(value){var _this=this,frame=this;return this._resolved=!1,this.async=value.then((function(v){return frame.value=v,_this._resolved=!0,frame.value})),frame}},{key:"isAsync",value:function(){return utils.isPromise(this.async)}}]),MemoFrame}(),globalOperationId=0,Scheduler=function(){function Scheduler(){_classCallCheck(this,Scheduler),this._pendingOps={},this._lastOperationId={}}return _createClass(Scheduler,[{key:"add",value:function(key,op){var _this=this,k=key.toString();if(this._pendingOps[k]){var opId=globalOperationId++;this._lastOperationId[k]=opId,this._pendingOps[k]=this._pendingOps[k].then((function(){return op()})).then((function(r){return _this._lastOperationId[k]===opId&&(delete _this._pendingOps[k],delete _this._lastOperationId[k]),r}))}else this._pendingOps[k]=op();return this._pendingOps[k]}}]),Scheduler}();!function(TransactionMode){TransactionMode.READONLY="readonly",TransactionMode.READ_WRITE="readwrite"}(TransactionMode||(TransactionMode={}));var IdbMemoDriver=function(_MemoDriver){_inherits(IdbMemoDriver,_MemoDriver);var _super=_createSuper(IdbMemoDriver);function IdbMemoDriver(){var _this,_params=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,IdbMemoDriver),(_this=_super.call(this))._params=_params,_this.NAME=IdbMemoDriver.NAME,_this._scheduler=new Scheduler,_this._init$=_this._openDb(),_this}return _createClass(IdbMemoDriver,[{key:"_idb",get:function(){var _a;return null!==(_a=this._params.indexedDB)&&void 0!==_a?_a:indexedDB}},{key:"_ls",get:function(){return this._localStorageDriver=this._findLsDriver(),this._localStorageDriver}},{key:"getKeys",value:function(namespace){return this._runTransactional((function(store){return store.getAllKeys()}),TransactionMode.READONLY).then((function(result){return result.map((function(id){return id.toString()})).map((function(str){return MemoKey.parse(str,!1)})).filter((function(k){return!!k}))}))}},{key:"_openDb",value:function(){var _this2=this;return new Promise((function(resolve,reject){var dbRequest=_this2._idb.open(IdbMemoDriver.DATABASE_NAME,IdbMemoDriver.DATABASE_VERSION);dbRequest.addEventListener("upgradeneeded",(function(){dbRequest.result.createObjectStore(IdbMemoDriver.STORE_NAME,{keyPath:"ref",autoIncrement:!1}).createIndex("by_key","key",{unique:!0})})),dbRequest.addEventListener("success",(function(){return resolve(dbRequest.result)})),dbRequest.addEventListener("error",(function(err){return reject(err)}))}))}},{key:"getPriority",value:function(context){return 100}},{key:"accepts",value:function(context){return context.frame.isAsync()}},{key:"read",value:function(key){var _a,_this3=this,metaKey=createMetaKey(key),metaEntry=this._ls.read(metaKey);if(!metaEntry)return null;utils.assert(!!(null===(_a=metaEntry.frame)||void 0===_a?void 0:_a.type)),utils.assert(!!metaEntry.key);var asyncValue=this._runTransactional((function(tx){return tx.get(key.toString())})).then((function(frame){if(!frame)throw _this3._ls.remove(metaKey),new MemoAspectError("No data found for key ".concat(key));return frame.value})),frame=new MemoFrame(Object.assign(Object.assign({},metaEntry),metaEntry.frame)).setAsyncValue(asyncValue);return this._scheduler.add(key.toString(),(function(){return frame.async})),frame?Object.assign(Object.assign({},metaEntry),{key:key,frame:frame}):void 0}},{key:"remove",value:function(key){var _this4=this;return this._scheduler.add(key.toString(),(function(){return _this4._deleteIdbEntry(key).then((function(){return _this4._deleteLsEntry(key)}))})).then((function(){}))}},{key:"write",value:function(entry){var _this5=this;return this._scheduler.add(entry.key.toString(),(function(){var _a=entry.frame,value=_a.value,metaFrame=function(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t}(_a,["value"]),metaEntry=Object.assign(Object.assign({},entry),{key:createMetaKey(entry.key),frame:metaFrame});_this5._ls.write(metaEntry);var valueFrame={ref:entry.key.toString(),value:value};return _this5._runTransactional((function(s){return s.put(valueFrame)}))}))}},{key:"_deleteIdbEntry",value:function(key){return this._runTransactional((function(s){return s.delete(key.toString())}))}},{key:"_deleteLsEntry",value:function(key){this._ls.remove(key)}},{key:"_runTransactional",value:function(transactionFn){var mode=arguments.length>1&&void 0!==arguments[1]?arguments[1]:TransactionMode.READ_WRITE;return this._init$.then((function(database){return new Promise((function(resolve,reject){var store=database.transaction(IdbMemoDriver.STORE_NAME,mode).objectStore(IdbMemoDriver.STORE_NAME),request=transactionFn(store);request.addEventListener("success",(function(){return resolve(request.result)})),request.addEventListener("error",(function(r){var _a,_b,error=null!==(_b=null===(_a=r.target)||void 0===_a?void 0:_a.error)&&void 0!==_b?_b:r;return console.error(error),reject(error)}))}))}))}},{key:"_findLsDriver",value:function(){if(this._localStorageDriver)return this._localStorageDriver;if(this._params.localStorageDriver)return this._params.localStorageDriver;var drivers=core.WEAVER_CONTEXT.getWeaver().getAspect("@aspectjs/memo").getDrivers();if(!drivers.localStorage)throw new MemoAspectError("".concat(IdbMemoDriver.prototype.constructor.name,' requires a "localStorage" driver, but option "localStorageDriver" is not set and no driver could be found with name "localStorage"'));return drivers.localStorage}}]),IdbMemoDriver}(MemoDriver);function createMetaKey(key){return new MemoKey(key,"".concat(key.namespace,"[idb_meta]"))}function hash(str){return str.split("").map((function(v){return v.charCodeAt(0)})).reduce((function(a,v){return a+((a<<7)+(a<<3))^v})).toString(16)}IdbMemoDriver.NAME="indexedDb",IdbMemoDriver.DATABASE_NAME="IndexedDbMemoAspect_db",IdbMemoDriver.STORE_NAME="results",IdbMemoDriver.DATABASE_VERSION=1;var InstantPromise=function(){function InstantPromise(){_classCallCheck(this,InstantPromise),this._onfulfilled=[],this._onrejected=[]}return _createClass(InstantPromise,[{key:"then",value:function(onfulfilled,onrejected){if(this._resolved){var res=onfulfilled(this._value);return utils.isPromise(res)?res:(new InstantPromise).resolve(res)}var delegate=new InstantPromise;return this._onfulfilled.push((function(r){return delegate.resolve(onfulfilled?onfulfilled(r):void 0)})),this._onrejected.push((function(r){return delegate.resolve(onrejected?onrejected(r):void 0)})),delegate}},{key:"resolve",value:function(value){if(this._resolved)throw new Error("promise already resolved");return this._resolved=!0,this._value=value,this._onfulfilled&&this._onfulfilled.forEach((function(f){return f(value)})),this}},{key:"reject",value:function(rejectValue){if(this._resolved)throw new Error("promise already resolved");return this._resolved=!0,this._rejectValue=rejectValue,this._onrejected&&this._onrejected.forEach((function(f){return f(rejectValue)})),this}}],[{key:"resolve",value:function(value){return(new InstantPromise).resolve(value)}},{key:"all",value:function(){for(var results=[],promise=(new InstantPromise).resolve(results),_len=arguments.length,promises=new Array(_len),_key=0;_key<_len;_key++)promises[_key]=arguments[_key];return promises.forEach((function(p,i){promise=promise.then((function(){return p})).then((function(v){return results[i]=v}))})),promise}}]),InstantPromise}();function provider(arg){return utils.isFunction(arg)?arg:function(){return arg}}
/*! (c) 2020 Andrea Giammarchi */var RawMemoField,$parse=JSON.parse,$stringify=JSON.stringify,keys=Object.keys,Primitive=String,ignore={},noop=function(_,value){return value},primitives=function(value){return value instanceof Primitive?Primitive(value):value},Primitives=function(_,value){return"string"===_typeof(value)?new Primitive(value):value},revive=function revive(input,parsed,output,$){for(var lazy=[],ke=keys(output),length=ke.length,y=0;y<length;y++){var k=ke[y],value=output[k];if(value instanceof Primitive){var tmp=input[value];"object"!==_typeof(tmp)||parsed.has(tmp)?output[k]=$.call(output,k,tmp):(parsed.add(tmp),output[k]=ignore,lazy.push({k:k,a:[input,parsed,tmp,$]}))}else output[k]!==ignore&&(output[k]=$.call(output,k,value))}for(var _length=lazy.length,i=0;i<_length;i++){var _lazy$i=lazy[i],_k=_lazy$i.k,a=_lazy$i.a;output[_k]=$.call(output,_k,revive.apply(null,a))}return output},set=function(known,input,value){var index=Primitive(input.push(value)-1);return known.set(value,index),index},parse=function(text,reviver){var input=$parse(text,Primitives).map(primitives),value=input[0],$=reviver||noop,tmp="object"===_typeof(value)&&value?revive(input,new Set,value,$):value;return $.call({"":tmp},"",tmp)},stringify=function(value,replacer,space){for(var $=replacer&&"object"===_typeof(replacer)?function(k,v){return""===k||-1<replacer.indexOf(k)?v:void 0}:replacer||noop,known=new Map,input=[],output=[],i=+set(known,input,$.call({"":value},"",value)),firstRun=!i;i<input.length;)firstRun=!0,output[i]=$stringify(input[i++],replace,space);return"["+output.join(",")+"]";function replace(key,value){if(firstRun)return firstRun=!firstRun,value;var after=$.call(this,key,value);switch(_typeof(after)){case"object":if(null===after)return after;case"string":return known.get(after)||set(known,input,after)}return after}};!function(RawMemoField){RawMemoField[RawMemoField.VALUE=0]="VALUE",RawMemoField[RawMemoField.TYPE=1]="TYPE",RawMemoField[RawMemoField.INSTANCE_TYPE=2]="INSTANCE_TYPE",RawMemoField[RawMemoField.EXPIRATION=3]="EXPIRATION",RawMemoField[RawMemoField.VERSION=4]="VERSION",RawMemoField[RawMemoField.SIGNATURE=5]="SIGNATURE",RawMemoField[RawMemoField.HASH=6]="HASH"}(RawMemoField||(RawMemoField={}));var F=RawMemoField,SimpleLsSerializer=function(){function SimpleLsSerializer(){_classCallCheck(this,SimpleLsSerializer)}return _createClass(SimpleLsSerializer,[{key:"deserialize",value:function(serialized){if(!serialized)return null;var raw=parse(serialized);return{expiration:raw[F.EXPIRATION]?new Date(raw[F.EXPIRATION]):void 0,frame:new MemoFrame({value:raw[F.VALUE],type:raw[F.TYPE],instanceType:raw[F.INSTANCE_TYPE],version:raw[F.VERSION],hash:raw[F.HASH]}),signature:raw[F.SIGNATURE]}}},{key:"serialize",value:function(entry){var raw={};return utils.isUndefined(entry.frame.value)||(raw[F.VALUE]=entry.frame.value),utils.isUndefined(entry.frame.type)||(raw[F.TYPE]=entry.frame.type),utils.isUndefined(entry.frame.instanceType)||(raw[F.INSTANCE_TYPE]=entry.frame.instanceType),utils.isUndefined(entry.frame.version)||(raw[F.VERSION]=entry.frame.version),utils.isUndefined(entry.frame.hash)||(raw[F.HASH]=entry.frame.hash),utils.isUndefined(entry.expiration)||(raw[F.EXPIRATION]=entry.expiration),utils.isUndefined(entry.signature)||(raw[F.SIGNATURE]=entry.signature),stringify(raw)}}]),SimpleLsSerializer}(),DEFAULT_LS_DRIVER_OPTIONS={serializer:new SimpleLsSerializer},LsMemoDriver=function(_MemoDriver){_inherits(LsMemoDriver,_MemoDriver);var _super=_createSuper(LsMemoDriver);function LsMemoDriver(options){var _this;if(_classCallCheck(this,LsMemoDriver),(_this=_super.call(this)).options=options,_this.NAME=LsMemoDriver.NAME,_this.options=Object.assign(Object.assign({},DEFAULT_LS_DRIVER_OPTIONS),options),!_this._ls)throw new Error("localStorage not available on this platform, and no implementation was provided");return _this}return _createClass(LsMemoDriver,[{key:"_ls",get:function(){var _a;return null!==(_a=this.options.localStorage)&&void 0!==_a?_a:localStorage}},{key:"getKeys",value:function(namespace){for(var res=[],i=0;i<this._ls.length;++i){var kStr=this._ls.key(i),key=MemoKey.parse(kStr,!1);(null==key?void 0:key.namespace)===namespace&&res.push(key)}return Promise.resolve(res)}},{key:"getPriority",value:function(context){return 10}},{key:"read",value:function(key){var _a,_b,frame=(null!==(_b=null===(_a=this.options)||void 0===_a?void 0:_a.serializer)&&void 0!==_b?_b:DEFAULT_LS_DRIVER_OPTIONS.serializer).deserialize(this._ls.getItem(key.toString()));return frame?Object.assign({key:key},frame):void 0}},{key:"write",value:function(entry){var _a,_b,serializer=null!==(_b=null===(_a=this.options)||void 0===_a?void 0:_a.serializer)&&void 0!==_b?_b:DEFAULT_LS_DRIVER_OPTIONS.serializer;return this._ls.setItem(entry.key.toString(),serializer.serialize(entry)),InstantPromise.resolve()}},{key:"remove",value:function(key){return this._ls.removeItem(key.toString()),InstantPromise.resolve()}}]),LsMemoDriver}(MemoDriver);LsMemoDriver.NAME="localStorage";
/*!
  MIT License
  Copyright (c) 2013 pieroxy

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
  */
var f=String.fromCharCode;function compressToUTF16(input){return null==input?"":function(uncompressed,bitsPerChar,getCharFromInt){if(null==uncompressed)return"";for(var i,value,context_dictionary={},context_dictionaryToCreate={},context_data=[],context_c="",context_wc="",context_w="",context_enlargeIn=2,context_dictSize=3,context_numBits=2,context_data_val=0,context_data_position=0,ii=0;ii<uncompressed.length;ii+=1)if(context_c=uncompressed.charAt(ii),Object.prototype.hasOwnProperty.call(context_dictionary,context_c)||(context_dictionary[context_c]=context_dictSize++,context_dictionaryToCreate[context_c]=!0),context_wc=context_w+context_c,Object.prototype.hasOwnProperty.call(context_dictionary,context_wc))context_w=context_wc;else{if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++)context_data_val<<=1,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++;for(value=context_w.charCodeAt(0),i=0;i<8;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1}else{for(value=1,i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value=0;for(value=context_w.charCodeAt(0),i=0;i<16;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1}0==--context_enlargeIn&&(context_enlargeIn=Math.pow(2,context_numBits),context_numBits++),delete context_dictionaryToCreate[context_w]}else for(value=context_dictionary[context_w],i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1;0==--context_enlargeIn&&(context_enlargeIn=Math.pow(2,context_numBits),context_numBits++),context_dictionary[context_wc]=context_dictSize++,context_w=String(context_c)}if(""!==context_w){if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++)context_data_val<<=1,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++;for(value=context_w.charCodeAt(0),i=0;i<8;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1}else{for(value=1,i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value=0;for(value=context_w.charCodeAt(0),i=0;i<16;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1}0==--context_enlargeIn&&(context_enlargeIn=Math.pow(2,context_numBits),context_numBits++),delete context_dictionaryToCreate[context_w]}else for(value=context_dictionary[context_w],i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1;0==--context_enlargeIn&&(context_enlargeIn=Math.pow(2,context_numBits),context_numBits++)}for(value=2,i=0;i<context_numBits;i++)context_data_val=context_data_val<<1|1&value,context_data_position==bitsPerChar-1?(context_data_position=0,context_data.push(getCharFromInt(context_data_val)),context_data_val=0):context_data_position++,value>>=1;for(;;){if(context_data_val<<=1,context_data_position==bitsPerChar-1){context_data.push(getCharFromInt(context_data_val));break}context_data_position++}return context_data.join("")}(input,15,(function(a){return f(a+32)}))+" "}function decompressFromUTF16(compressed){return null==compressed?"":""==compressed?null:function(length,resetValue,getNextValue){var w,i,bits,resb,maxpower,power,c,entry="",dictionary=[],result=[],data={val:getNextValue(0),position:resetValue,index:1},enlargeIn=4,dictSize=4,numBits=3;for(i=0;i<3;i+=1)dictionary[i]=i;bits=0,maxpower=Math.pow(2,2),power=1;for(;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(resb>0?1:0)*power,power<<=1;switch(bits){case 0:for(bits=0,maxpower=Math.pow(2,8),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(resb>0?1:0)*power,power<<=1;c=f(bits);break;case 1:for(bits=0,maxpower=Math.pow(2,16),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(resb>0?1:0)*power,power<<=1;c=f(bits);break;case 2:return""}dictionary[3]=c,w=c,result.push(c);for(;;){if(data.index>length)return"";for(bits=0,maxpower=Math.pow(2,numBits),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(resb>0?1:0)*power,power<<=1;switch(c=bits){case 0:for(bits=0,maxpower=Math.pow(2,8),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(resb>0?1:0)*power,power<<=1;dictionary[dictSize++]=f(bits),c=dictSize-1,enlargeIn--;break;case 1:for(bits=0,maxpower=Math.pow(2,16),power=1;power!=maxpower;)resb=data.val&data.position,data.position>>=1,0==data.position&&(data.position=resetValue,data.val=getNextValue(data.index++)),bits|=(resb>0?1:0)*power,power<<=1;dictionary[dictSize++]=f(bits),c=dictSize-1,enlargeIn--;break;case 2:return result.join("")}if(0==enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++),dictionary[c])entry=dictionary[c];else{if(c!==dictSize)return null;entry=w+w.charAt(0)}result.push(entry),dictionary[dictSize++]=w+entry.charAt(0),w=entry,0==--enlargeIn&&(enlargeIn=Math.pow(2,numBits),numBits++)}}(compressed.length,16384,(function(index){return compressed.charCodeAt(index)-32}))}var LzMemoSerializer=function(_SimpleLsSerializer){_inherits(LzMemoSerializer,_SimpleLsSerializer);var _super=_createSuper(LzMemoSerializer);function LzMemoSerializer(){return _classCallCheck(this,LzMemoSerializer),_super.apply(this,arguments)}return _createClass(LzMemoSerializer,[{key:"deserialize",value:function(str){return str?_get(_getPrototypeOf(LzMemoSerializer.prototype),"deserialize",this).call(this,decompressFromUTF16(str)):null}},{key:"serialize",value:function(obj){return obj?compressToUTF16(_get(_getPrototypeOf(LzMemoSerializer.prototype),"serialize",this).call(this,obj)):null}}]),LzMemoSerializer}(SimpleLsSerializer),toStringFunction=Function.prototype.toString,create=Object.create,defineProperty=Object.defineProperty,getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor,getOwnPropertyNames=Object.getOwnPropertyNames,getOwnPropertySymbols=Object.getOwnPropertySymbols,getPrototypeOf=Object.getPrototypeOf,_a=Object.prototype,hasOwnProperty=_a.hasOwnProperty,propertyIsEnumerable=_a.propertyIsEnumerable,SUPPORTS_SYMBOL_PROPERTIES="function"==typeof getOwnPropertySymbols,SUPPORTS_WEAKMAP="function"==typeof WeakMap,getCleanClone=function(object,realm){if(!object.constructor)return create(null);var Constructor=object.constructor,prototype=object.__proto__||getPrototypeOf(object);if(Constructor===realm.Object)return prototype===realm.Object.prototype?{}:create(prototype);if(~toStringFunction.call(Constructor).indexOf("[native code]"))try{return new Constructor}catch(_a){}return create(prototype)},getObjectCloneLoose=function(object,realm,handleCopy,cache){var clone=getCleanClone(object,realm);for(var key in cache.set(object,clone),object)hasOwnProperty.call(object,key)&&(clone[key]=handleCopy(object[key],cache));if(SUPPORTS_SYMBOL_PROPERTIES){var symbols=getOwnPropertySymbols(object),length_1=symbols.length;if(length_1)for(var index=0,symbol=void 0;index<length_1;index++)symbol=symbols[index],propertyIsEnumerable.call(object,symbol)&&(clone[symbol]=handleCopy(object[symbol],cache))}return clone},getObjectCloneStrict=function(object,realm,handleCopy,cache){var clone=getCleanClone(object,realm);cache.set(object,clone);var properties=SUPPORTS_SYMBOL_PROPERTIES?getOwnPropertyNames(object).concat(getOwnPropertySymbols(object)):getOwnPropertyNames(object),length=properties.length;if(length)for(var index=0,property=void 0,descriptor=void 0;index<length;index++)if("callee"!==(property=properties[index])&&"caller"!==property)if(descriptor=getOwnPropertyDescriptor(object,property)){descriptor.get||descriptor.set||(descriptor.value=handleCopy(object[property],cache));try{defineProperty(clone,property,descriptor)}catch(error){clone[property]=descriptor.value}}else clone[property]=handleCopy(object[property],cache);return clone},isArray=Array.isArray,GLOBAL_THIS="undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void(console&&console.error&&console.error('Unable to locate global object, returning "this".'));function copy(object,options){var isStrict=!(!options||!options.isStrict),realm=options&&options.realm||GLOBAL_THIS,getObjectClone=isStrict?getObjectCloneStrict:getObjectCloneLoose;return function handleCopy(object,cache){if(!object||"object"!==_typeof(object))return object;if(cache.has(object))return cache.get(object);var clone,regExp,flags,Constructor=object.constructor;if(Constructor===realm.Object)return getObjectClone(object,realm,handleCopy,cache);if(isArray(object)){if(isStrict)return getObjectCloneStrict(object,realm,handleCopy,cache);var length_1=object.length;clone=new Constructor,cache.set(object,clone);for(var index=0;index<length_1;index++)clone[index]=handleCopy(object[index],cache);return clone}if(object instanceof realm.Date)return new Constructor(object.getTime());if(object instanceof realm.RegExp)return(clone=new Constructor(object.source,object.flags||(flags="",(regExp=object).global&&(flags+="g"),regExp.ignoreCase&&(flags+="i"),regExp.multiline&&(flags+="m"),regExp.unicode&&(flags+="u"),regExp.sticky&&(flags+="y"),flags))).lastIndex=object.lastIndex,clone;if(realm.Map&&object instanceof realm.Map)return clone=new Constructor,cache.set(object,clone),object.forEach((function(value,key){clone.set(key,handleCopy(value,cache))})),clone;if(realm.Set&&object instanceof realm.Set)return clone=new Constructor,cache.set(object,clone),object.forEach((function(value){clone.add(handleCopy(value,cache))})),clone;if(realm.Blob&&object instanceof realm.Blob)return object.slice(0,object.size,object.type);if(realm.Buffer&&realm.Buffer.isBuffer(object))return clone=realm.Buffer.allocUnsafe?realm.Buffer.allocUnsafe(object.length):new Constructor(object.length),cache.set(object,clone),object.copy(clone),clone;if(realm.ArrayBuffer){if(realm.ArrayBuffer.isView(object))return clone=new Constructor(object.buffer.slice(0)),cache.set(object,clone),clone;if(object instanceof realm.ArrayBuffer)return clone=object.slice(0),cache.set(object,clone),clone}return"function"==typeof object.then||object instanceof Error||realm.WeakMap&&object instanceof realm.WeakMap||realm.WeakSet&&object instanceof realm.WeakSet?object:getObjectClone(object,realm,handleCopy,cache)}(object,function(){if(SUPPORTS_WEAKMAP)return new WeakMap;var object=create({has:function(key){return!!~object._keys.indexOf(key)},set:function(key,value){object._keys.push(key),object._values.push(value)},get:function(key){return object._values[object._keys.indexOf(key)]}});return object._keys=[],object._values=[],object}())}copy.default=copy,copy.strict=function(object,options){return copy(object,{isStrict:!0,realm:options?options.realm:void 0})};var MemoMarshaller=function MemoMarshaller(){_classCallCheck(this,MemoMarshaller)},ObjectMarshaller=function(_MemoMarshaller){_inherits(ObjectMarshaller,_MemoMarshaller);var _super=_createSuper(ObjectMarshaller);function ObjectMarshaller(){var _this;return _classCallCheck(this,ObjectMarshaller),(_this=_super.apply(this,arguments)).types=["Object","object"],_this}return _createClass(ObjectMarshaller,[{key:"marshal",value:function(frame,context,defaultMarshal){return frame.value?frame.setValue([].concat(Object.getOwnPropertyNames(frame.value)).concat(Object.getOwnPropertySymbols(frame.value)).reduce((function(w,k){var v=frame.value[k];return w[k]=defaultMarshal(v),w}),{})):frame}},{key:"unmarshal",value:function(frame,context,defaultUnmarshal){if(null===frame.value)return null;var value={};return context.blacklist.set(frame,value),utils.assert(!!frame.value),[].concat(Object.getOwnPropertyNames(frame.value)).concat(Object.getOwnPropertySymbols(frame.value)).reduce((function(v,k){return v[k]=defaultUnmarshal(frame.value[k]),v}),value)}}]),ObjectMarshaller}(MemoMarshaller),CacheableMarshaller=function(_MemoMarshaller){_inherits(CacheableMarshaller,_MemoMarshaller);var _super=_createSuper(CacheableMarshaller);function CacheableMarshaller(options){var _this,_a,_b;return _classCallCheck(this,CacheableMarshaller),(_this=_super.call(this)).types="*",_this._objectMarshaller=null!==(_a=null==options?void 0:options.objectMarshaller)&&void 0!==_a?_a:new ObjectMarshaller,_this._nonCacheableHandler=null!==(_b=null==options?void 0:options.nonCacheableHandler)&&void 0!==_b?_b:function(proto){var name=proto.constructor.name;throw new TypeError('Type "'.concat(name,'" is not annotated with "').concat(_Cacheable,'". Please add "').concat(_Cacheable,'" on class "').concat(name,'", or register a proper ').concat(MemoMarshaller.name," for this type."))},_this}return _createClass(CacheableMarshaller,[{key:"marshal",value:function(frame,context,defaultMarshal){var proto=Reflect.getPrototypeOf(frame.value),ts=typeStore(),instanceType=ts.getTypeKey(proto);instanceType||this._nonCacheableHandler(proto);var newFrame=this._objectMarshaller.marshal(frame,context,defaultMarshal);return newFrame.hash=__createHash(proto),newFrame.instanceType=instanceType,newFrame.version=provider(ts.getVersion(instanceType))(),newFrame}},{key:"unmarshal",value:function(frame,context,defaultUnmarshal){frame.value=this._objectMarshaller.unmarshal(frame,context,defaultUnmarshal),utils.assert(!!frame.instanceType);var ts=typeStore(),proto=ts.getPrototype(frame.instanceType),version=provider(ts.getVersion(frame.instanceType))();if(version!==frame.version&&version!==frame.version)throw new VersionConflictError("Object for key ".concat(frame.instanceType," is of version ").concat(version,", but incompatible version ").concat(frame.version," was already cached"),context);if(void 0===version&&frame.hash!==__createHash(proto))throw new VersionConflictError("Hash changed for type ".concat(frame.instanceType," "),context);return Reflect.setPrototypeOf(frame.value,proto),frame.value}}]),CacheableMarshaller}(MemoMarshaller);function typeStore(){var weaver=core.WEAVER_CONTEXT.getWeaver();if(!weaver)throw new commons.WeavingError("no weaver configured. Please call setWeaver()");var cacheableAspect=weaver.getAspect("@aspectjs/cacheable");if(!cacheableAspect)throw new commons.WeavingError('MemoAspect requires an aspect to be registered for id "@aspectjs/cacheable". Did you forgot to call getWeaver().enable(new DefaultCacheableAspect()) ?');return cacheableAspect.cacheTypeStore}function __createHash(proto){for(var s=[],p=proto;p!==Object.prototype;)s.push(p.constructor.toString()),p=Reflect.getPrototypeOf(p);return hash(s.join())}var ArrayMarshaller=function(_MemoMarshaller){_inherits(ArrayMarshaller,_MemoMarshaller);var _super=_createSuper(ArrayMarshaller);function ArrayMarshaller(){var _this;return _classCallCheck(this,ArrayMarshaller),(_this=_super.apply(this,arguments)).types="Array",_this}return _createClass(ArrayMarshaller,[{key:"marshal",value:function(frame,context,defaultMarshal){return frame.value=frame.value.map((function(i){return defaultMarshal(i)})),frame}},{key:"unmarshal",value:function(frame,context,defaultUnmarshal){var value=[];return context.blacklist.set(frame,value),value.push.apply(value,_toConsumableArray(frame.value.map((function(w){return defaultUnmarshal(w)})))),value}}]),ArrayMarshaller}(MemoMarshaller),BasicMarshaller=function(_MemoMarshaller){_inherits(BasicMarshaller,_MemoMarshaller);var _super=_createSuper(BasicMarshaller);function BasicMarshaller(){var _this;return _classCallCheck(this,BasicMarshaller),(_this=_super.apply(this,arguments)).types=["Number","String","Boolean","symbol","number","string","boolean","symbol","undefined"],_this}return _createClass(BasicMarshaller,[{key:"marshal",value:function(frame){return frame}},{key:"unmarshal",value:function(frame){return frame.value}}]),BasicMarshaller}(MemoMarshaller),DateMarshaller=function(_MemoMarshaller){_inherits(DateMarshaller,_MemoMarshaller);var _super=_createSuper(DateMarshaller);function DateMarshaller(){var _this;return _classCallCheck(this,DateMarshaller),(_this=_super.apply(this,arguments)).types="Date",_this}return _createClass(DateMarshaller,[{key:"marshal",value:function(frame){return frame.setValue(stringify(frame.value))}},{key:"unmarshal",value:function(frame){return new Date(parse(frame.value))}}]),DateMarshaller}(MemoMarshaller),NoopMarshaller=function(_MemoMarshaller){_inherits(NoopMarshaller,_MemoMarshaller);var _super=_createSuper(NoopMarshaller);function NoopMarshaller(){return _classCallCheck(this,NoopMarshaller),_super.apply(this,arguments)}return _createClass(NoopMarshaller,[{key:"marshal",value:function(value){return new MemoFrame({value:value})}},{key:"unmarshal",value:function(frame){return frame.value}}]),NoopMarshaller}(MemoMarshaller),PromiseMarshaller=function(_MemoMarshaller){_inherits(PromiseMarshaller,_MemoMarshaller);var _super=_createSuper(PromiseMarshaller);function PromiseMarshaller(){var _this;return _classCallCheck(this,PromiseMarshaller),(_this=_super.apply(this,arguments)).types="Promise",_this}return _createClass(PromiseMarshaller,[{key:"marshal",value:function(frame,context,defaultMarshal){return frame.setAsyncValue(frame.value.then((function(v){return defaultMarshal(v)}))),frame}},{key:"unmarshal",value:function(frame,context,defaultUnmarshal){return frame.isAsync()?frame.async.then((function(v){return defaultUnmarshal(v)})):Promise.resolve(defaultUnmarshal(frame.value))}}]),PromiseMarshaller}(MemoMarshaller),MarshallersRegistry=function(){function MarshallersRegistry(){_classCallCheck(this,MarshallersRegistry),this._marshallers={}}return _createClass(MarshallersRegistry,[{key:"addMarshaller",value:function(){for(var _this=this,_len=arguments.length,marshallers=new Array(_len),_key=0;_key<_len;_key++)marshallers[_key]=arguments[_key];return(null!=marshallers?marshallers:[]).forEach((function(marshaller){[marshaller.types].flat().forEach((function(type){_this._marshallers[type]=marshaller}))})),this}},{key:"removeMarshaller",value:function(){for(var _this2=this,_len2=arguments.length,marshallers=new Array(_len2),_key2=0;_key2<_len2;_key2++)marshallers[_key2]=arguments[_key2];return(null!=marshallers?marshallers:[]).forEach((function(marshaller){[marshaller.types].flat().forEach((function(type){delete _this2._marshallers[type]}))})),this}},{key:"getMarshaller",value:function(typeName){var _a,marshaller=null!==(_a=this._marshallers[typeName])&&void 0!==_a?_a:this._marshallers["*"];if(!marshaller)throw new TypeError("No marshaller to handle value of type ".concat(typeName));return marshaller}},{key:"marshal",value:function(value){return new MarshallingContextImpl(this,value)}},{key:"unmarshal",value:function(frame){return new UnmarshallingContextImpl(this,frame).frame.value}}]),MarshallersRegistry}(),MarshallingContextImpl=function(){function MarshallingContextImpl(_marshallersRegistry,value){_classCallCheck(this,MarshallingContextImpl),this._marshallersRegistry=_marshallersRegistry,this.value=value,this._blacklist=new Map,this._promises=[],this.frame=this._defaultMarshal(this.value)}return _createClass(MarshallingContextImpl,[{key:"_defaultMarshal",value:function(value){var _a;if(this._blacklist.has(value))return this._blacklist.get(value);var type=null!==(_a=null==value?void 0:value.constructor.name)&&void 0!==_a?_a:_typeof(value),marshaller=this._marshallersRegistry.getMarshaller(type),baseFrame=new MemoFrame({value:value,type:type});(utils.isObject(value)||utils.isArray(value))&&this._blacklist.set(value,baseFrame);var frame=marshaller.marshal(baseFrame,this,this._defaultMarshal.bind(this));return frame.isAsync()&&this._promises.push(frame.async),frame}},{key:"then",value:function(onfulfilled,onrejected){var _this3=this;return InstantPromise.all.apply(InstantPromise,_toConsumableArray(this._promises)).then((function(){return _this3.frame})).then(onfulfilled,onrejected)}}]),MarshallingContextImpl}(),UnmarshallingContextImpl=function(){function UnmarshallingContextImpl(_marshallersRegistry,frame){_classCallCheck(this,UnmarshallingContextImpl),this._marshallersRegistry=_marshallersRegistry,this.frame=frame,this.blacklist=new Map,this._defaultUnmarshal(this.frame)}return _createClass(UnmarshallingContextImpl,[{key:"_defaultUnmarshal",value:function(frame){var _a;if(utils.assert(!!frame),this.blacklist.has(frame))return this.blacklist.get(frame);if(!frame)return null;frame instanceof MemoFrame||Reflect.setPrototypeOf(frame,MemoFrame.prototype),utils.assert(!!frame.type);var typeName=null!==(_a=frame.type)&&void 0!==_a?_a:"*",marshaller=this._marshallersRegistry.getMarshaller(typeName);return frame.value=marshaller.unmarshal(frame,this,this._defaultUnmarshal.bind(this)),frame.value}}]),UnmarshallingContextImpl}(),Memo=commons.ASPECTJS_ANNOTATION_FACTORY.create((function(options){})),DEFAULT_MARSHALLERS=[new ObjectMarshaller,new ArrayMarshaller,new DateMarshaller,new PromiseMarshaller,new CacheableMarshaller,new BasicMarshaller];Object.freeze(DEFAULT_MARSHALLERS);var internalId=0,DEFAULT_MEMO_ASPECT_OPTIONS={id:function(ctxt){var _a,_b,_ctxt$instance=ctxt.instance,id=_ctxt$instance.id,_id=_ctxt$instance._id,hashcode=_ctxt$instance.hashcode,_hashcode=_ctxt$instance._hashcode,result=null!==(_b=null!==(_a=null!=id?id:_id)&&void 0!==_a?_a:hashcode)&&void 0!==_b?_b:_hashcode;return utils.isUndefined(result)?utils.getOrComputeMetadata("@aspectjs:memo/id",ctxt.instance,(function(){return internalId++})):result},namespace:"",createMemoKey:function(ctxt){return new MemoKey({namespace:ctxt.data.namespace,instanceId:ctxt.data.instanceId,argsKey:hash(stringify(ctxt.args)),targetKey:hash("".concat(ctxt.target.ref))})},expiration:void 0,marshallers:DEFAULT_MARSHALLERS,drivers:[]};function __createContextSignature(ctxt){for(var s=[],proto=ctxt.target.proto,property=proto[ctxt.target.propertyKey];proto!==Object.prototype&&property;)s.push(ctxt.target.proto[ctxt.target.propertyKey].toString()),property=(proto=Reflect.getPrototypeOf(proto))[ctxt.target.propertyKey];return hash(s.join())}exports.MemoAspect=function(){function MemoAspect(params){var _a,_b;_classCallCheck(this,MemoAspect),this._drivers={},this._entriesGc=new Map,this._pendingResults=new Map,this._options=Object.assign(Object.assign({},DEFAULT_MEMO_ASPECT_OPTIONS),params),this._marshallers=new MarshallersRegistry,this.addMarshaller.apply(this,DEFAULT_MARSHALLERS.concat(_toConsumableArray(null!==(_a=this._options.marshallers)&&void 0!==_a?_a:[]))),this.addDriver.apply(this,_toConsumableArray(null!==(_b=null==params?void 0:params.drivers)&&void 0!==_b?_b:[]))}return _createClass(MemoAspect,[{key:"getDrivers",value:function(){return this._drivers}},{key:"addDriver",value:function(){for(var _this=this,_len=arguments.length,drivers=new Array(_len),_key=0;_key<_len;_key++)drivers[_key]=arguments[_key];return(null!=drivers?drivers:[]).forEach((function(d){var _a,_b,existingDriver=_this._drivers[d.NAME];if(existingDriver!==d){if(existingDriver)throw new Error("both ".concat(null===(_a=d.constructor)||void 0===_a?void 0:_a.name," & ").concat(null===(_b=existingDriver.constructor)||void 0===_b?void 0:_b.name," configured for name ").concat(d.NAME));_this._drivers[d.NAME]=d,_this._enabled&&_this._initGc(d)}})),this}},{key:"onEnable",value:function(){var _this2=this;this._enabled=!0,Object.values(this._drivers).forEach((function(d){return _this2._initGc(d)}))}},{key:"addMarshaller",value:function(){var _this$_marshallers;(_this$_marshallers=this._marshallers).addMarshaller.apply(_this$_marshallers,arguments)}},{key:"removeMarshaller",value:function(){var _this$_marshallers2;(_this$_marshallers2=this._marshallers).removeMarshaller.apply(_this$_marshallers2,arguments)}},{key:"applyMemo",value:function(ctxt,jp){var _a,_b,_c,_d,_this3=this,memoParams=ctxt.annotations.onSelf(Memo)[0].args[0];ctxt.data.namespace=null!==(_a=provider(null==memoParams?void 0:memoParams.namespace)())&&void 0!==_a?_a:provider(null===(_b=this._options)||void 0===_b?void 0:_b.namespace)(),ctxt.data.instanceId="".concat(null!==(_c=provider(null==memoParams?void 0:memoParams.id)(ctxt))&&void 0!==_c?_c:provider(null===(_d=this._options)||void 0===_d?void 0:_d.id)(ctxt));var key=this._options.createMemoKey(ctxt);if(!key)throw new Error("".concat(this._options.createMemoKey.name," function did not return a valid MemoKey"));var options=ctxt.annotations.onSelf(Memo)[0].args[0],expiration=this.getExpiration(ctxt,options),drivers=function(drivers,ctxt){var _a,_b,annotationOptions=null!==(_a=ctxt.annotations.onSelf(Memo)[0].args[0])&&void 0!==_a?_a:{};if(annotationOptions.driver){if(utils.isString(annotationOptions.driver)){var candidates=Object.values(drivers).filter((function(d){return d.NAME===annotationOptions.driver}));if(!candidates.length)throw new commons.AspectError(ctxt,'No candidate driver available for driver name "'.concat(annotationOptions.driver,'"'));return candidates}if(utils.isFunction(annotationOptions.driver)){var _candidates=Object.values(drivers).filter((function(d){return d.constructor===annotationOptions.driver}));if(!_candidates.length)throw new commons.AspectError(ctxt,'No candidate driver available for driver "'.concat(null===(_b=annotationOptions.driver)||void 0===_b?void 0:_b.name,'"'));return _candidates}throw new commons.AspectError(ctxt,"driver option should be a string or a Driver constructor. Got: ".concat(annotationOptions.driver))}return Object.values(drivers)}(this._drivers,ctxt),pendingResults=this._pendingResults.get(key.toString());if(pendingResults)return copy(pendingResults);var _step,_iterator=function(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}(drivers);try{for(_iterator.s();!(_step=_iterator.n()).done;){var d=_step.value;try{var entry=d.read(key);if(entry)if(entry.expiration&&entry.expiration<new Date)this._removeValue(d,key);else{if(!entry.signature||entry.signature===__createContextSignature(ctxt))return this._marshallers.unmarshal(entry.frame);console.debug("".concat(ctxt.target.label," hash mismatch. Removing memoized data...")),this._removeValue(d,key)}}catch(e){if(!(e instanceof VersionConflictError||e instanceof MemoAspectError))throw e;console.error(e),this._removeValue(d,key)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return function(){var _a,_b,_c,value=jp();_this3._pendingResults.set(key.toString(),value);var marshallingContext=_this3._marshallers.marshal(value),driver=drivers.filter((function(d){return d.accepts(marshallingContext)})).map((function(d){return[d,d.getPriority(marshallingContext)]})).sort((function(dp1,dp2){return dp2[1]-dp1[1]})).map((function(dp){return dp[0]}))[0];if(!driver)throw new commons.AspectError(ctxt,"Driver ".concat(drivers[0].NAME," does not accept value of type ").concat(null!==(_c=null===(_b=null===(_a=utils.getProto(value))||void 0===_a?void 0:_a.constructor)||void 0===_b?void 0:_b.name)&&void 0!==_c?_c:_typeof(value)," returned by ").concat(ctxt.target.label));return expiration&&_this3._scheduleCleaner(driver,key,expiration),marshallingContext.then((function(frame){var entry={key:key,expiration:expiration,frame:frame,signature:__createContextSignature(ctxt)};driver.write(entry).then((function(){_this3._pendingResults.get(key.toString())===value&&_this3._pendingResults.delete(key.toString())}))})),value}()}},{key:"_removeValue",value:function(driver,key){driver.remove(key);var t=this._entriesGc.get(key.toString());this._pendingResults.delete(key.toString()),void 0!==t&&(this._entriesGc.delete(key.toString()),clearTimeout(t))}},{key:"_scheduleCleaner",value:function(driver,key,expiration){var _this4=this,ttl=expiration.getTime()-(new Date).getTime();ttl<=0?this._removeValue(driver,key):this._entriesGc.set(key.toString(),setTimeout((function(){return _this4._removeValue(driver,key)}),ttl))}},{key:"_initGc",value:function(driver){var _this5=this;driver.getKeys().then((function(keys){keys.forEach((function(k){Promise.resolve(driver.read(k)).then((function(memo){(null==memo?void 0:memo.expiration)&&_this5._scheduleCleaner(driver,k,memo.expiration)}))}))}))}},{key:"getExpiration",value:function(ctxt,options){var exp=provider(null==options?void 0:options.expiration)();if(exp){if(exp instanceof Date)return exp;if("number"==typeof exp&&exp>0)return new Date((new Date).getTime()+1e3*exp);if(0===exp)return;throw new commons.AspectError(ctxt,"expiration should be either a Date or a positive number. Got: ".concat(exp))}}}]),MemoAspect}(),__decorate([annotations.Around(commons.on.method.withAnnotations(Memo)),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Function]),__metadata("design:returntype",Object)],exports.MemoAspect.prototype,"applyMemo",null),exports.MemoAspect=__decorate([annotations.Aspect("@aspectjs/memo"),__metadata("design:paramtypes",[Object])],exports.MemoAspect);var MemoProfile=function(_WeaverProfile){_inherits(MemoProfile,_WeaverProfile);var _super=_createSuper(MemoProfile);function MemoProfile(memoProfileFeatures){var _this,_a,_b,_c,_d;_classCallCheck(this,MemoProfile),(_this=_super.call(this))._features={useLocalStorage:!0,useIndexedDb:!0,useLzString:!0,options:{}},_this.enable(new exports.DefaultCacheableAspect),_this._features.options=null!==(_a=null==memoProfileFeatures?void 0:memoProfileFeatures.options)&&void 0!==_a?_a:_this._features.options,_this._features.useIndexedDb=null!==(_b=null==memoProfileFeatures?void 0:memoProfileFeatures.useIndexedDb)&&void 0!==_b?_b:_this._features.useIndexedDb,_this._features.useLzString=null!==(_c=null==memoProfileFeatures?void 0:memoProfileFeatures.useLzString)&&void 0!==_c?_c:_this._features.useLzString,_this._features.useLocalStorage=null!==(_d=null==memoProfileFeatures?void 0:memoProfileFeatures.useLocalStorage)&&void 0!==_d?_d:_this._features.useLocalStorage;var serializer,marshallers=_toConsumableArray(DEFAULT_MARSHALLERS),drivers=[];(_this._features.useIndexedDb&&drivers.push(new IdbMemoDriver),_this._features.useLocalStorage)&&(_this._features.useLzString&&(serializer=new LzMemoSerializer),drivers.push(new LsMemoDriver({serializer:serializer})));var memoAspect=new exports.MemoAspect(Object.assign(Object.assign({},_this._features.options),{marshallers:marshallers,drivers:drivers}));return _this.enable(memoAspect),_this}return _createClass(MemoProfile,[{key:"configure",value:function(features){return new MemoProfile(Object.assign(Object.assign({},this._features),features))}}]),MemoProfile}(commons.WeaverProfile),MEMO_PROFILE=new(function(_MemoProfile){_inherits(DefaultMemoProfile,_MemoProfile);var _super=_createSuper(DefaultMemoProfile);function DefaultMemoProfile(){return _classCallCheck(this,DefaultMemoProfile),_super.apply(this,arguments)}return _createClass(DefaultMemoProfile,[{key:"register",value:function(){core.WEAVER_CONTEXT.getWeaver().enable(this)}},{key:"configure",value:function(features){return new DefaultMemoProfile(Object.assign(Object.assign({},this._features),features))}}]),DefaultMemoProfile}(MemoProfile));exports.ArrayMarshaller=ArrayMarshaller,exports.BasicMarshaller=BasicMarshaller,exports.Cacheable=_Cacheable,exports.CacheableMarshaller=CacheableMarshaller,exports.DEFAULT_LS_DRIVER_OPTIONS=DEFAULT_LS_DRIVER_OPTIONS,exports.DEFAULT_MARSHALLERS=DEFAULT_MARSHALLERS,exports.DateMarshaller=DateMarshaller,exports.IdbMemoDriver=IdbMemoDriver,exports.LsMemoDriver=LsMemoDriver,exports.LzMemoSerializer=LzMemoSerializer,exports.MEMO_PROFILE=MEMO_PROFILE,exports.Memo=Memo,exports.MemoDriver=MemoDriver,exports.MemoFrame=MemoFrame,exports.MemoKey=MemoKey,exports.MemoMarshaller=MemoMarshaller,exports.MemoProfile=MemoProfile,exports.NoopMarshaller=NoopMarshaller,exports.ObjectMarshaller=ObjectMarshaller,exports.PromiseMarshaller=PromiseMarshaller,exports.SimpleLsSerializer=SimpleLsSerializer,exports._CacheTypeStoreImpl=_CacheTypeStoreImpl}));
//# sourceMappingURL=memo.umd.min.js.map
