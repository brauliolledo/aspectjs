{"version":3,"file":"cacheable-marshaller.js","sources":["../../../../../../../../../src/marshalling/marshallers/cacheable-marshaller.ts"],"sourcesContent":["import { WEAVER_CONTEXT } from '@aspectjs/core';\nimport { assert, isUndefined } from '@aspectjs/core/utils';\nimport { WeavingError } from '@aspectjs/core/commons';\nimport { Cacheable } from '../../cacheable/cacheable.annotation';\nimport { MemoFrame } from '../../drivers';\nimport { VersionConflictError } from '../../errors';\nimport { CacheableAspect, CacheTypeStore } from '../../cacheable/cacheable.aspect';\nimport { MarshalFn, MemoMarshaller } from './marshaller';\nimport { ObjectMarshaller } from './object-marshaller';\nimport { MarshallingContext, UnmarshallingContext } from '../marshalling-context';\nimport { provider, hash } from '../../utils';\n\n/**\n * Supports marshalling instances of classes annotated with @Cacheable\n * @public\n */\nexport class CacheableMarshaller extends MemoMarshaller {\n    readonly types = '*';\n    private _objectMarshaller: ObjectMarshaller;\n    private _nonCacheableHandler: (proto: object) => void;\n\n    constructor(options?: { objectMarshaller: ObjectMarshaller; nonCacheableHandler: (proto: object) => void }) {\n        super();\n        this._objectMarshaller = options?.objectMarshaller ?? new ObjectMarshaller();\n        this._nonCacheableHandler =\n            options?.nonCacheableHandler ??\n            ((proto) => {\n                const name = proto.constructor.name;\n                throw new TypeError(\n                    `Type \"${name}\" is not annotated with \"${Cacheable}\". Please add \"${Cacheable}\" on class \"${name}\", or register a proper ${MemoMarshaller.name} for this type.`,\n                );\n            });\n    }\n    marshal(frame: MemoFrame<object>, context: MarshallingContext, defaultMarshal: MarshalFn): MemoFrame {\n        // delete wrap.type; // Do not store useless type, as INSTANCE_TYPE is used for objects of non-built-in types.\n        const proto = Reflect.getPrototypeOf(frame.value);\n\n        const ts = typeStore();\n        const instanceType = ts.getTypeKey(proto);\n\n        if (!instanceType) {\n            this._nonCacheableHandler(proto);\n        }\n\n        const newFrame = this._objectMarshaller.marshal(frame, context, defaultMarshal);\n\n        newFrame.hash = __createHash(proto);\n        newFrame.instanceType = instanceType;\n        newFrame.version = provider(ts.getVersion(instanceType))();\n\n        return newFrame;\n    }\n    unmarshal(frame: MemoFrame<object>, context: UnmarshallingContext, defaultUnmarshal: MarshalFn): any {\n        frame.value = this._objectMarshaller.unmarshal(frame, context, defaultUnmarshal);\n\n        assert(!!frame.instanceType);\n        const ts = typeStore();\n        const proto = ts.getPrototype(frame.instanceType);\n        const version = provider(ts.getVersion(frame.instanceType))();\n        if (version !== frame.version) {\n            if (version !== frame.version) {\n                throw new VersionConflictError(\n                    `Object for key ${frame.instanceType} is of version ${version}, but incompatible version ${frame.version} was already cached`,\n                    context,\n                );\n            }\n        }\n        if (version === undefined && frame.hash !== __createHash(proto)) {\n            throw new VersionConflictError(`Hash changed for type ${frame.instanceType} `, context);\n        }\n        Reflect.setPrototypeOf(frame.value, proto);\n\n        return frame.value;\n    }\n}\n\nfunction typeStore(): CacheTypeStore {\n    const weaver = WEAVER_CONTEXT.getWeaver();\n    if (!weaver) {\n        throw new WeavingError('no weaver configured. Please call setWeaver()');\n    }\n\n    const cacheableAspect = weaver.getAspect('@aspectjs/cacheable') as CacheableAspect;\n\n    if (!cacheableAspect) {\n        throw new WeavingError(\n            'MemoAspect requires an aspect to be registered for id \"@aspectjs/cacheable\".' +\n                ' Did you forgot to call getWeaver().enable(new DefaultCacheableAspect()) ?',\n        );\n    }\n\n    return cacheableAspect.cacheTypeStore;\n}\n\nfunction __createHash(proto: object): string {\n    const s: string[] = [];\n    let p = proto;\n    while (p !== Object.prototype) {\n        s.push(p.constructor.toString());\n        p = Reflect.getPrototypeOf(p);\n    }\n    return hash(s.join());\n}\n"],"names":["Cacheable"],"mappings":"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"}