{"version":3,"file":"instant-promise.js","sources":["../../../../../../../../src/utils/instant-promise.ts"],"sourcesContent":["/**\n * Like Promise.resolve, but call resolve synchronously as soon as '.then' gets called\n */\nimport { isPromise } from '@aspectjs/core/utils';\n\nexport class InstantPromise<T> implements PromiseLike<T> {\n    private _resolved: boolean;\n    private _value?: T;\n    private _rejectValue?: any;\n    private _onfulfilled: ((r: any) => InstantPromise<unknown>)[] = [];\n    private _onrejected: ((r: any) => InstantPromise<unknown>)[] = [];\n\n    constructor() {}\n\n    static resolve<T>(value?: T) {\n        return new InstantPromise<T>().resolve(value);\n    }\n\n    static all(...promises: PromiseLike<any>[]): PromiseLike<any[]> {\n        const results: any[] = [];\n\n        let promise: PromiseLike<any[]> = new InstantPromise<any[]>().resolve(results);\n        promises.forEach((p, i) => {\n            promise = promise.then(() => p).then((v) => (results[i] = v));\n        });\n\n        return promise;\n    }\n\n    then<TResult1 = T, TResult2 = never>(\n        onfulfilled?: (value: T) => TResult1 | PromiseLike<TResult1>,\n        onrejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | undefined | null,\n    ): PromiseLike<TResult1 | TResult2> {\n        if (this._resolved) {\n            const res = onfulfilled(this._value);\n            if (isPromise(res)) {\n                return res;\n            } else {\n                return new InstantPromise<any>().resolve(res);\n            }\n        } else {\n            const delegate = new InstantPromise<TResult1>();\n            this._onfulfilled.push((r: any) => delegate.resolve(onfulfilled ? (onfulfilled(r) as any) : undefined));\n            this._onrejected.push((r: any) => delegate.resolve(onrejected ? (onrejected(r) as any) : undefined));\n            return delegate;\n        }\n    }\n\n    resolve(value: T): this {\n        if (this._resolved) {\n            throw new Error('promise already resolved');\n        }\n        this._resolved = true;\n        this._value = value;\n        if (this._onfulfilled) {\n            this._onfulfilled.forEach((f) => f(value));\n        }\n\n        return this;\n    }\n\n    reject(rejectValue: any): this {\n        if (this._resolved) {\n            throw new Error('promise already resolved');\n        }\n        this._resolved = true;\n        this._rejectValue = rejectValue;\n        if (this._onrejected) {\n            this._onrejected.forEach((f) => f(rejectValue));\n        }\n\n        return this;\n    }\n}\n"],"names":[],"mappings":";;AAAA;;;MAKa,cAAc;IAOvB;QAHQ,iBAAY,GAA4C,EAAE,CAAC;QAC3D,gBAAW,GAA4C,EAAE,CAAC;KAElD;IAEhB,OAAO,OAAO,CAAI,KAAS;QACvB,OAAO,IAAI,cAAc,EAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;KACjD;IAED,OAAO,GAAG,CAAC,GAAG,QAA4B;QACtC,MAAM,OAAO,GAAU,EAAE,CAAC;QAE1B,IAAI,OAAO,GAAuB,IAAI,cAAc,EAAS,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;QAC/E,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC;YAClB,OAAO,GAAG,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;SACjE,CAAC,CAAC;QAEH,OAAO,OAAO,CAAC;KAClB;IAED,IAAI,CACA,WAA4D,EAC5D,UAAmF;QAEnF,IAAI,IAAI,CAAC,SAAS,EAAE;YAChB,MAAM,GAAG,GAAG,WAAW,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACrC,IAAI,SAAS,CAAC,GAAG,CAAC,EAAE;gBAChB,OAAO,GAAG,CAAC;aACd;iBAAM;gBACH,OAAO,IAAI,cAAc,EAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;aACjD;SACJ;aAAM;YACH,MAAM,QAAQ,GAAG,IAAI,cAAc,EAAY,CAAC;YAChD,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,CAAM,KAAK,QAAQ,CAAC,OAAO,CAAC,WAAW,GAAI,WAAW,CAAC,CAAC,CAAS,GAAG,SAAS,CAAC,CAAC,CAAC;YACxG,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAM,KAAK,QAAQ,CAAC,OAAO,CAAC,UAAU,GAAI,UAAU,CAAC,CAAC,CAAS,GAAG,SAAS,CAAC,CAAC,CAAC;YACrG,OAAO,QAAQ,CAAC;SACnB;KACJ;IAED,OAAO,CAAC,KAAQ;QACZ,IAAI,IAAI,CAAC,SAAS,EAAE;YAChB,MAAM,IAAI,KAAK,CAAC,0BAA0B,CAAC,CAAC;SAC/C;QACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACpB,IAAI,IAAI,CAAC,YAAY,EAAE;YACnB,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;SAC9C;QAED,OAAO,IAAI,CAAC;KACf;IAED,MAAM,CAAC,WAAgB;QACnB,IAAI,IAAI,CAAC,SAAS,EAAE;YAChB,MAAM,IAAI,KAAK,CAAC,0BAA0B,CAAC,CAAC;SAC/C;QACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC;QAChC,IAAI,IAAI,CAAC,WAAW,EAAE;YAClB,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;SACnD;QAED,OAAO,IAAI,CAAC;KACf;;;;;"}