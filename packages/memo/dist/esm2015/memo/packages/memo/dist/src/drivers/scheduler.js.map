{"version":3,"file":"scheduler.js","sources":["../../../../../../../../src/drivers/scheduler.ts"],"sourcesContent":["/**\n * In case a @Memo method returns a promise, the corresponding MemoValue\n * can be persisted only once the promise gets resolved. As a result, all subsequent operations should be deferred.\n * This stores all the pending operations for a given key in call order,\n * to ensure an operation does not occurs before the previous operations.\n */\nlet globalOperationId = 0;\nexport class Scheduler {\n    private readonly _pendingOps: Record<string, PromiseLike<any>> = {};\n    private readonly _lastOperationId: Record<string, number> = {};\n\n    /** Add the given promise to the promise queue for this key **/\n    add<T>(key: string, op: () => PromiseLike<T>): T extends Promise<any> ? T : PromiseLike<T> {\n        const k = key.toString();\n        if (this._pendingOps[k]) {\n            const opId = globalOperationId++;\n            this._lastOperationId[k] = opId;\n\n            this._pendingOps[k] = this._pendingOps[k]\n                .then(() => op())\n                .then((r) => {\n                    if (this._lastOperationId[k] === opId) {\n                        delete this._pendingOps[k];\n                        delete this._lastOperationId[k];\n                    }\n\n                    return r;\n                });\n        } else {\n            this._pendingOps[k] = op();\n        }\n\n        return this._pendingOps[k] as any;\n    }\n}\n"],"names":[],"mappings":"AAAA;;;;;;AAMA,IAAI,iBAAiB,GAAG,CAAC,CAAC;MACb,SAAS;IAAtB;QACqB,gBAAW,GAAqC,EAAE,CAAC;QACnD,qBAAgB,GAA2B,EAAE,CAAC;KAyBlE;;IAtBG,GAAG,CAAI,GAAW,EAAE,EAAwB;QACxC,MAAM,CAAC,GAAG,GAAG,CAAC,QAAQ,EAAE,CAAC;QACzB,IAAI,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,EAAE;YACrB,MAAM,IAAI,GAAG,iBAAiB,EAAE,CAAC;YACjC,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC;YAEhC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;iBACpC,IAAI,CAAC,MAAM,EAAE,EAAE,CAAC;iBAChB,IAAI,CAAC,CAAC,CAAC;gBACJ,IAAI,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,KAAK,IAAI,EAAE;oBACnC,OAAO,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;oBAC3B,OAAO,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;iBACnC;gBAED,OAAO,CAAC,CAAC;aACZ,CAAC,CAAC;SACV;aAAM;YACH,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC;SAC9B;QAED,OAAO,IAAI,CAAC,WAAW,CAAC,CAAC,CAAQ,CAAC;KACrC;;;;;"}