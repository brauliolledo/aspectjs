{"version":3,"file":"localstorage.driver.js","sources":["../../../../../../../../../src/drivers/localstorage/localstorage.driver.ts"],"sourcesContent":["import { MarshallingContext } from '../../marshalling/marshalling-context';\nimport { MemoEntry, MemoKey } from '../../memo.types';\nimport { InstantPromise } from '../../utils';\nimport { MemoDriver } from '../memo.driver';\nimport { SimpleLsSerializer } from './serializers/ls-serializer';\nimport { LsMemoSerializer } from './serializers/ls-serializer.type';\n\n/**\n * Options supported by the LsMemoDriver\n * @public\n */\nexport interface LsMemoDriverOptions {\n    localStorage?: typeof localStorage;\n    serializer?: LsMemoSerializer;\n}\n\n/**\n * @public\n */\nexport const DEFAULT_LS_DRIVER_OPTIONS = {\n    serializer: new SimpleLsSerializer(),\n};\n\n/**\n * Memo driver to store async @Memo result into the Indexed Database.\n * @public\n */\nexport class LsMemoDriver extends MemoDriver {\n    static readonly NAME = 'localStorage';\n    readonly NAME = LsMemoDriver.NAME;\n\n    constructor(public options?: LsMemoDriverOptions) {\n        super();\n        this.options = { ...DEFAULT_LS_DRIVER_OPTIONS, ...options };\n        if (!this._ls) {\n            throw new Error('localStorage not available on this platform, and no implementation was provided');\n        }\n    }\n\n    private get _ls(): typeof localStorage {\n        return this.options.localStorage ?? localStorage;\n    }\n\n    getKeys(namespace: string): Promise<MemoKey[]> {\n        const res: MemoKey[] = [];\n        for (let i = 0; i < this._ls.length; ++i) {\n            const kStr = this._ls.key(i);\n            const key = MemoKey.parse(kStr, false);\n            if (key?.namespace === namespace) {\n                res.push(key);\n            }\n        }\n\n        return Promise.resolve(res);\n    }\n\n    /**\n     * Accepts all kind of results\n     * @param context - the marshalling context for the current 'to-be-stored' value\n     */\n    getPriority(context: MarshallingContext): number {\n        return 10;\n    }\n\n    read<T>(key: MemoKey): MemoEntry<T> {\n        const serializer = this.options?.serializer ?? DEFAULT_LS_DRIVER_OPTIONS.serializer;\n        const frame = serializer.deserialize(this._ls.getItem(key.toString())) as MemoEntry<T>;\n        return frame\n            ? {\n                  key,\n                  ...frame,\n              }\n            : undefined;\n    }\n\n    write(entry: MemoEntry): PromiseLike<void> {\n        const serializer = this.options?.serializer ?? DEFAULT_LS_DRIVER_OPTIONS.serializer;\n        this._ls.setItem(entry.key.toString(), serializer.serialize(entry));\n        return InstantPromise.resolve();\n    }\n\n    remove(key: MemoKey): PromiseLike<void> {\n        this._ls.removeItem(key.toString());\n        return InstantPromise.resolve();\n    }\n}\n"],"names":[],"mappings":";;;;;AAgBA;;;MAGa,yBAAyB,GAAG;IACrC,UAAU,EAAE,IAAI,kBAAkB,EAAE;EACtC;AAEF;;;;MAIa,YAAa,SAAQ,UAAU;IAIxC,YAAmB,OAA6B;QAC5C,KAAK,EAAE,CAAC;QADO,YAAO,GAAP,OAAO,CAAsB;QAFvC,SAAI,GAAG,YAAY,CAAC,IAAI,CAAC;QAI9B,IAAI,CAAC,OAAO,mCAAQ,yBAAyB,GAAK,OAAO,CAAE,CAAC;QAC5D,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;YACX,MAAM,IAAI,KAAK,CAAC,iFAAiF,CAAC,CAAC;SACtG;KACJ;IAED,IAAY,GAAG;;QACX,OAAO,MAAA,IAAI,CAAC,OAAO,CAAC,YAAY,mCAAI,YAAY,CAAC;KACpD;IAED,OAAO,CAAC,SAAiB;QACrB,MAAM,GAAG,GAAc,EAAE,CAAC;QAC1B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE;YACtC,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YAC7B,MAAM,GAAG,GAAG,OAAO,CAAC,KAAK,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;YACvC,IAAI,CAAA,GAAG,aAAH,GAAG,uBAAH,GAAG,CAAE,SAAS,MAAK,SAAS,EAAE;gBAC9B,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;aACjB;SACJ;QAED,OAAO,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;KAC/B;;;;;IAMD,WAAW,CAAC,OAA2B;QACnC,OAAO,EAAE,CAAC;KACb;IAED,IAAI,CAAI,GAAY;;QAChB,MAAM,UAAU,GAAG,MAAA,MAAA,IAAI,CAAC,OAAO,0CAAE,UAAU,mCAAI,yBAAyB,CAAC,UAAU,CAAC;QACpF,MAAM,KAAK,GAAG,UAAU,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAiB,CAAC;QACvF,OAAO,KAAK;8BAEF,GAAG,IACA,KAAK,IAEZ,SAAS,CAAC;KACnB;IAED,KAAK,CAAC,KAAgB;;QAClB,MAAM,UAAU,GAAG,MAAA,MAAA,IAAI,CAAC,OAAO,0CAAE,UAAU,mCAAI,yBAAyB,CAAC,UAAU,CAAC;QACpF,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,EAAE,UAAU,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC;QACpE,OAAO,cAAc,CAAC,OAAO,EAAE,CAAC;KACnC;IAED,MAAM,CAAC,GAAY;QACf,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC;QACpC,OAAO,cAAc,CAAC,OAAO,EAAE,CAAC;KACnC;;AAxDe,iBAAI,GAAG,cAAc;;;;"}