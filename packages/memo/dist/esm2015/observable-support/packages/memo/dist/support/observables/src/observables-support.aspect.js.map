{"version":3,"file":"observables-support.aspect.js","sources":["../../../../../../../../../support/observables/src/observables-support.aspect.ts"],"sourcesContent":["import { AfterReturn, Aspect } from '@aspectjs/core/annotations';\nimport { AfterReturnContext, AspectType, on, WeaverProfile, WeavingError } from '@aspectjs/core/commons';\nimport { Memo, MemoAspect } from '@aspectjs/memo';\n\nimport { isObservable } from 'rxjs';\nimport { shareReplay } from 'rxjs/operators';\n\nimport { ObservableMarshaller } from './observable-marshaller';\n\n/**\n * Enable support for Observables memoization.\n * @public\n */\n@Aspect('@aspectjs/memo:ObservableMemoSupportAspect')\nexport class ObservableMemoSupportAspect implements AspectType {\n    onEnable(weaver: WeaverProfile) {\n        const memoAspect = weaver.getAspect(MemoAspect);\n        if (!memoAspect) {\n            throw new WeavingError(\n                `Cannot enable ${ObservableMemoSupportAspect.name}: ${MemoAspect.name} should be enabled first`,\n            );\n        }\n        memoAspect.addMarshaller(new ObservableMarshaller());\n    }\n    onDisable(weaver: WeaverProfile) {\n        weaver.getAspect(MemoAspect)?.removeMarshaller(new ObservableMarshaller());\n    }\n    @AfterReturn(on.method.withAnnotations(Memo))\n    shareReplay(ctxt: AfterReturnContext) {\n        if (isObservable(ctxt.value)) {\n            return ctxt.value.pipe(shareReplay(1));\n        }\n        return ctxt.value;\n    }\n}\n"],"names":[],"mappings":";;;;;;;;;AASA;;;;IAKa,2BAA2B,mCAAxC,MAAa,2BAA2B;IACpC,QAAQ,CAAC,MAAqB;QAC1B,MAAM,UAAU,GAAG,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;QAChD,IAAI,CAAC,UAAU,EAAE;YACb,MAAM,IAAI,YAAY,CAClB,iBAAiB,6BAA2B,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,0BAA0B,CAClG,CAAC;SACL;QACD,UAAU,CAAC,aAAa,CAAC,IAAI,oBAAoB,EAAE,CAAC,CAAC;KACxD;IACD,SAAS,CAAC,MAAqB;;QAC3B,MAAA,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,0CAAE,gBAAgB,CAAC,IAAI,oBAAoB,EAAE,CAAC,CAAC;KAC9E;IAED,WAAW,CAAC,IAAwB;QAChC,IAAI,YAAY,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;YAC1B,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;SAC1C;QACD,OAAO,IAAI,CAAC,KAAK,CAAC;KACrB;EACJ;AANG;IADC,WAAW,CAAC,EAAE,CAAC,MAAM,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;;;;8DAM5C;AAnBQ,2BAA2B;IADvC,MAAM,CAAC,4CAA4C,CAAC;GACxC,2BAA2B,CAoBvC;;;;"}